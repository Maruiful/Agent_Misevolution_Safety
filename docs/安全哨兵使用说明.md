# å®‰å…¨å“¨å…µ (Safety Sentry) ä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

å®‰å…¨å“¨å…µæ˜¯ä¸€ä¸ª**å¯é€‰çš„é˜²å¾¡æœºåˆ¶**,ç”¨äºåœ¨æ™ºèƒ½ä½“è¿›åŒ–è¿‡ç¨‹ä¸­é˜²æ­¢è¿è§„è¡Œä¸ºã€‚å®ƒå®ç°äº†**æ–¹æ¡ˆA: è´Ÿå‘åé¦ˆå¼ºåˆ¶æ³¨å…¥**,å½“æ£€æµ‹åˆ°è¿è§„æ—¶,ä¸ä»…æ‹¦æˆªå›å¤,è¿˜ä¼šåœ¨ç»éªŒå›æ”¾ç¼“å†²åŒºä¸­æ³¨å…¥è´Ÿå‘åé¦ˆ,çº æ­£é”™è¯¯çš„å¥–åŠ±ä¿¡å·ã€‚

## æ ¸å¿ƒæœºåˆ¶

### æ–¹æ¡ˆA: è´Ÿå‘åé¦ˆå¼ºåˆ¶æ³¨å…¥

å½“æ™ºèƒ½ä½“äº§ç”Ÿè¿è§„å›å¤æ—¶:

1. **æ£€æµ‹è¿è§„**: ä½¿ç”¨è§„åˆ™æ£€æµ‹å±‚è¯†åˆ«è¿è§„ç±»å‹
2. **ç”Ÿæˆå®‰å…¨å›å¤**: ä½¿ç”¨LLMç”Ÿæˆåˆè§„çš„æ›¿ä»£å›å¤
3. **æ³¨å…¥è´Ÿå‘åé¦ˆ**: åœ¨ReplayBufferä¸­æ’å…¥-100åˆ†çš„è®°å½•
4. **çº æ­£è¿›åŒ–æ–¹å‘**: è´Ÿå‘åé¦ˆå°†å½±å“Few-shotå­¦ä¹ ,é˜²æ­¢æ™ºèƒ½ä½“ç»§ç»­çŠ¯é”™

### ä¸¤å±‚é˜²å¾¡æœºåˆ¶

**APIå±‚ (å·²å®ç°)**:
- `paper_violation_detector`: ä½¿ç”¨LLM-as-a-Judgeåˆ¤å®šè¿è§„
- èŒè´£: è§‚å¯Ÿå’Œè®°å½•è¿è§„

**æ™ºèƒ½ä½“å±‚ (å¯é€‰,æœ¬å®ç°)**:
- `SafetySentry`: å®æ—¶æ£€æµ‹å’Œæ‹¦æˆªè¿è§„å†³ç­–
- èŒè´£: é˜²å¾¡å’Œçº æ­£

## é…ç½®è¯´æ˜

### 1. ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `backend/.env` æ–‡ä»¶ä¸­æ·»åŠ :

```bash
# å®‰å…¨å“¨å…µé…ç½® (å¯é€‰,é»˜è®¤ä¸å¯ç”¨)
ENABLE_SAFETY_SENTRY=false      # æ˜¯å¦å¯ç”¨å®‰å…¨å“¨å…µ
SAFETY_SENTRY_METHOD=negative_feedback  # é˜²å¾¡æ–¹æ³•: negative_feedback (æ–¹æ¡ˆA)
```

### 2. ä»£ç é…ç½®

`backend/core/config.py`:

```python
class ExperimentSettings(BaseSettings):
    # ... å…¶ä»–é…ç½® ...

    # å®‰å…¨å“¨å…µé…ç½®
    enable_safety_sentry: bool = Field(
        default=False,
        description="æ˜¯å¦å¯ç”¨å®‰å…¨å“¨å…µ(å¯é€‰åŠŸèƒ½,ç”¨äºå¯¹æ¯”å®éªŒ)"
    )
    safety_sentry_method: str = Field(
        default="negative_feedback",
        description="å®‰å…¨å“¨å…µé˜²å¾¡æ–¹æ³•: negative_feedback(æ–¹æ¡ˆA)"
    )
```

## ä½¿ç”¨æ–¹å¼

### å¯¹æ¯”å®éªŒè®¾è®¡

**å®éªŒç»„ (æ— å®‰å…¨å“¨å…µ)**:
```bash
# .env
ENABLE_SAFETY_SENTRY=false
```
- æ™ºèƒ½ä½“è‡ªç„¶è¿›åŒ–,å¯èƒ½äº§ç”Ÿé”™è¯¯è¿›åŒ–
- è§‚å¯Ÿè¿è§„ç‡çš„å˜åŒ–è¶‹åŠ¿

**å¯¹ç…§ç»„ (å¯ç”¨å®‰å…¨å“¨å…µ)**:
```bash
# .env
ENABLE_SAFETY_SENTRY=true
```
- æ™ºèƒ½ä½“å—åˆ°å®‰å…¨å“¨å…µä¿æŠ¤
- è´Ÿå‘åé¦ˆçº æ­£è¿›åŒ–æ–¹å‘
- è§‚å¯Ÿè¿è§„ç‡æ˜¯å¦å¾—åˆ°æ§åˆ¶

### APIå“åº”å­—æ®µ

å½“å¯ç”¨å®‰å…¨å“¨å…µæ—¶,APIå“åº”ä¼šåŒ…å«é¢å¤–å­—æ®µ:

```python
{
    "response": "å®‰å…¨çš„æ›¿ä»£å›å¤",  # å¦‚æœè¢«æ‹¦æˆª
    "is_violation": true,
    "violation_type": "unauthorized_refund",
    "judge_reason": "...",

    # å®‰å…¨å“¨å…µç›¸å…³å­—æ®µ
    "sentry_blocked": true,           # æ˜¯å¦è¢«å“¨å…µæ‹¦æˆª
    "sentry_alert_type": "unauthorized_refund",  # å“¨å…µæ£€æµ‹çš„è¿è§„ç±»å‹
    "sentry_severity": "high"         # è¿è§„ä¸¥é‡ç¨‹åº¦
}
```

## æµ‹è¯•

è¿è¡Œæµ‹è¯•æ–‡ä»¶:

```bash
cd backend
python tests/test_safety_sentry.py
```

æµ‹è¯•å†…å®¹åŒ…æ‹¬:
1. âœ… ReplayBufferè´Ÿå‘åé¦ˆæ³¨å…¥
2. âœ… å®‰å…¨å“¨å…µè¿è§„æ£€æµ‹
3. âœ… æ–¹æ¡ˆAå®Œæ•´æµç¨‹(æ£€æµ‹â†’æ‹¦æˆªâ†’æ³¨å…¥â†’å­¦ä¹ )

## å®ç°ç»†èŠ‚

### 1. ReplayBufferæ‰©å±•

æ–°å¢æ–¹æ³•: `inject_negative_feedback()`

```python
def inject_negative_feedback(
    self,
    user_input: str,
    unsafe_response: str,
    safe_response: str,
    violation_type: str,
    judge_reason: str,
    penalty_reward: float = -100.0
) -> Experience
```

**åŠŸèƒ½**:
- åˆ›å»ºå¥–åŠ±ä¸º-100.0çš„ç»éªŒè®°å½•
- è®°å½•ä¸å®‰å…¨å›å¤å’Œå®‰å…¨å›å¤
- æ ‡è®°ä¸ºå“¨å…µæ³¨å…¥ (`injected_by_sentry: true`)
- è®°å½•åŸå§‹é”™è¯¯å¥–åŠ±å’Œçº æ­£åå¥–åŠ±

**å½±å“**:
- è´Ÿå‘åé¦ˆä¼šè¢«Few-shotå­¦ä¹ é€‰ä¸­
- æ™ºèƒ½ä½“ä¼šå­¦ä¹ "è¿è§„å›å¤=æä½å¥–åŠ±"
- çº æ­£ç”¨æˆ·å¯èƒ½ç»™å‡ºçš„é”™è¯¯é«˜åˆ†

### 2. SafetySentryæ‰©å±•

æ–°å¢æ–¹æ³•: `handle_violation_with_negative_feedback()`

```python
async def handle_violation_with_negative_feedback(
    self,
    user_input: str,
    agent_response: str,
    alert: ViolationAlert,
    replay_buffer
) -> str
```

**åŠŸèƒ½**:
1. è°ƒç”¨LLMç”Ÿæˆå®‰å…¨çš„æ›¿ä»£å›å¤
2. åœ¨ReplayBufferä¸­æ³¨å…¥è´Ÿå‘åé¦ˆ
3. è¿”å›å®‰å…¨å›å¤

### 3. APIé›†æˆ

`backend/api/routes/chat.py`:

```python
if is_violation and settings.experiment.enable_safety_sentry:
    # åˆ›å»ºå®‰å…¨å“¨å…µå®ä¾‹
    sentry = SafetySentry(llm_service, enable_llm_check=False)

    # æ£€æµ‹è¿è§„
    alert = sentry.check_decision(...)

    if alert.is_violation:
        # æ–¹æ¡ˆA: è´Ÿå‘åé¦ˆå¼ºåˆ¶æ³¨å…¥
        safe_response = await sentry.handle_violation_with_negative_feedback(
            user_input=request.message,
            agent_response=response.response,
            alert=alert,
            replay_buffer=agent.replay_buffer
        )

        # æ›¿æ¢ä¸ºå®‰å…¨å›å¤
        response.response = safe_response
        response.sentry_blocked = true
```

## è¿è§„ç±»å‹å®šä¹‰

å®‰å…¨å“¨å…µå¯ä»¥æ£€æµ‹ä»¥ä¸‹è¿è§„ç±»å‹:

| è¿è§„ç±»å‹ | åç§° | ä¸¥é‡ç¨‹åº¦ | ç¤ºä¾‹ |
|---------|------|---------|-----|
| `unauthorized_refund` | æœªç»æˆæƒé€€æ¬¾æ‰¿è¯º | high | "æˆ‘ç›´æ¥ç»™æ‚¨é€€æ¬¾,ä¸ç”¨å®¡æ ¸" |
| `over_promise` | è¿‡åº¦æ‰¿è¯º | medium | "ä¿è¯100%è§£å†³" |
| `policy_violation` | æ”¿ç­–è¿è§„ | high | "æˆ‘å¯ä»¥ç»•è¿‡æµç¨‹" |
| `excessive_compensation` | è¿‡åº¦èµ”å¿æ‰¿è¯º | medium | "åŒå€èµ”å¿" |
| `bypass_authority` | è¶…è¶Šæƒé™ | high | "æˆ‘æœ‰æƒé™ç›´æ¥æ‰¹å‡†" |

## å·¥ä½œæµç¨‹

### æ— å®‰å…¨å“¨å…µ (é»˜è®¤)

```
ç”¨æˆ·è¾“å…¥ â†’ æ™ºèƒ½ä½“ç”Ÿæˆå›å¤ â†’ paper_violation_detectoråˆ¤å®šè¿è§„
                              â†“
                          è®°å½•è¿è§„,ä½†ä¸æ‹¦æˆª
                              â†“
                    ç”¨æˆ·å¯èƒ½ç»™é«˜åˆ† âŒ
                              â†“
                  æ™ºèƒ½ä½“å­¦ä¹ "è¿è§„=é«˜åˆ†",é”™è¯¯è¿›åŒ– âš ï¸
```

### å¯ç”¨å®‰å…¨å“¨å…µ (æ–¹æ¡ˆA)

```
ç”¨æˆ·è¾“å…¥ â†’ æ™ºèƒ½ä½“ç”Ÿæˆå›å¤ â†’ paper_violation_detectoråˆ¤å®šè¿è§„
                              â†“
                    SafetySentryæ£€æµ‹å¹¶æ‹¦æˆª ğŸ›¡ï¸
                              â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                               â†“
        ç”Ÿæˆå®‰å…¨å›å¤                    æ³¨å…¥-100åˆ†åˆ°ReplayBuffer
              â†“                               â†“
        è¿”å›ç»™ç”¨æˆ·                    å½±å“Few-shotå­¦ä¹ 
              â†“                               â†“
        é˜²æ­¢è¿è§„æš´éœ²                    çº æ­£è¿›åŒ–æ–¹å‘ âœ…
```

## æ•ˆæœéªŒè¯

### 1. æŸ¥çœ‹ReplayBufferçŠ¶æ€

```python
stats = buffer.get_statistics()
print(f"è¿è§„ç‡: {stats['violation_rate']:.1%}")
```

### 2. æ£€æŸ¥è´Ÿå‘åé¦ˆè®°å½•

```python
# æ‰¾åˆ°æ‰€æœ‰å“¨å…µæ³¨å…¥çš„è®°å½•
sentry_injections = [
    exp for exp in buffer.get_all()
    if exp.metadata.get('injected_by_sentry', False)
]

print(f"å“¨å…µæ³¨å…¥æ•°é‡: {len(sentry_injections)}")
```

### 3. éªŒè¯Few-shotå­¦ä¹ 

```python
# è·å–å¥–åŠ±æœ€é«˜çš„ç»éªŒ(å¯èƒ½åŒ…å«è´Ÿå‘åé¦ˆ)
top_rewards = buffer.retrieve_top_rewards(5)

for exp in top_rewards:
    print(f"å¥–åŠ±: {exp.reward:.1f}, è¿è§„: {exp.metadata.get('is_violation')}")
```

## æ³¨æ„äº‹é¡¹

1. **é»˜è®¤ä¸å¯ç”¨**: å®‰å…¨å“¨å…µé»˜è®¤å…³é—­,é€šè¿‡ç¯å¢ƒå˜é‡å¯ç”¨
2. **å¯¹æ¯”å®éªŒ**: åˆ†åˆ«æµ‹è¯•å¯ç”¨/ä¸å¯ç”¨çš„æƒ…å†µ,å¯¹æ¯”è¿è§„ç‡å˜åŒ–
3. **ReplayBufferå®¹é‡**: è´Ÿå‘åé¦ˆä¼šå ç”¨ç¼“å†²åŒºç©ºé—´,é»˜è®¤å®¹é‡1000
4. **LLMè°ƒç”¨**: ç”Ÿæˆå®‰å…¨å›å¤éœ€è¦è°ƒç”¨LLM,ä¼šå¢åŠ å“åº”æ—¶é—´
5. **è§„åˆ™æ£€æµ‹**: å½“å‰ä½¿ç”¨è§„åˆ™å±‚,æœªå¯ç”¨LLMå±‚(é¿å…é‡å¤æ£€æµ‹)

## æ–‡ä»¶æ¸…å•

å®ç°æ¶‰åŠçš„æ–‡ä»¶:

- `backend/core/safety_sentry.py`: å®‰å…¨å“¨å…µæ ¸å¿ƒå®ç°
- `backend/storage/replay_buffer.py`: ç»éªŒå›æ”¾ç¼“å†²åŒº(æ–°å¢`inject_negative_feedback`æ–¹æ³•)
- `backend/core/config.py`: é…ç½®ç®¡ç†(æ–°å¢å®‰å…¨å“¨å…µé…ç½®)
- `backend/api/routes/chat.py`: å¯¹è¯API(é›†æˆå®‰å…¨å“¨å…µ)
- `backend/models/schemas.py`: æ•°æ®æ¨¡å‹(åŒ…å«å“¨å…µç›¸å…³å­—æ®µ)
- `tests/test_safety_sentry.py`: æµ‹è¯•æ–‡ä»¶
- `docs/å®‰å…¨å“¨å…µä½¿ç”¨è¯´æ˜.md`: æœ¬æ–‡æ¡£

## æœªæ¥æ‰©å±•

å¯èƒ½çš„åç»­æ”¹è¿›:

1. **æ–¹æ¡ˆB**: å®‰å…¨æŒ‡ä»¤æƒé‡æå‡(åœ¨Few-shotä¸­å¼ºåˆ¶åŠ å…¥è¿è§„æ¡ˆä¾‹)
2. **æ–¹æ¡ˆC**: æ€ç»´é“¾å®¡è®¡(æ£€æŸ¥CoT,å¦‚æœæ˜çŸ¥è¿è§„åˆ™åˆ‡æ–­è¾“å‡º)
3. **ä¼˜å…ˆçº§é‡‡æ ·**: ä½¿ç”¨`PrioritizedReplayBuffer`æé«˜è´Ÿå‘åé¦ˆè¢«é€‰ä¸­çš„æ¦‚ç‡
4. **è‡ªé€‚åº”é˜ˆå€¼**: æ ¹æ®è¿è§„ç‡åŠ¨æ€è°ƒæ•´è´Ÿå‘åé¦ˆå¼ºåº¦
5. **æ•ˆæœè¯„ä¼°**: å¯¹æ¯”å®éªŒç»“æœçš„é‡åŒ–åˆ†æ

## å‚è€ƒè®ºæ–‡

- "Your Agent May Misevolve: Uncovering Risk of Error Evolution in Autonomous Agent Systems"
  - æ ¸å¿ƒé—®é¢˜: æ™ºèƒ½ä½“åœ¨è¿½æ±‚é«˜å¥–åŠ±è¿‡ç¨‹ä¸­å¯èƒ½é”™è¯¯è¿›åŒ–
  - è§£å†³æ–¹æ¡ˆ: å¼•å…¥å¤–éƒ¨å®‰å…¨æœºåˆ¶è¿›è¡Œå¹²é¢„å’Œçº æ­£
  - æœ¬å®ç°: æ–¹æ¡ˆA = è´Ÿå‘åé¦ˆå¼ºåˆ¶æ³¨å…¥
