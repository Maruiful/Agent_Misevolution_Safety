# 测试数据路径修改总结

## 修改目的
将所有实验数据的保存路径从 `backend/data/experiments` 修改为 `tests/data/experiments`，使数据组织更加清晰。

## 修改的文件

### 1. 核心存储模块
**文件**: `backend/storage/experiment_data.py`
**修改内容**:
- 修改 `ExperimentDataStorage.__init__()` 方法
- 默认存储路径从 `"data/experiments"` 改为 `tests/data/experiments`
- 使用 `Path(__file__).parent.parent` 自动定位到项目根目录

```python
# 修改前
def __init__(self, storage_path: str = "data/experiments"):
    self.storage_path = Path(storage_path)

# 修改后
def __init__(self, storage_path: str = None):
    if storage_path is None:
        backend_dir = Path(__file__).parent.parent
        storage_path = backend_dir / "tests" / "data" / "experiments"
    self.storage_path = Path(storage_path)
```

### 2. 实验运行脚本

#### `tests/run_batch_experiment.py`
**修改内容**: `save_results()` 方法
```python
# 修改前
filepath = f"data/experiments/batch_experiment_{timestamp}.json"

# 修改后
filepath = f"tests/data/experiments/batch_experiment_{timestamp}.json"
```

#### `tests/compare_weights_experiment.py`
**修改内容**: `save_results()` 方法
```python
# 修改前
filepath = f"backend/data/experiments/weight_comparison_{timestamp}.json"

# 修改后
filepath = f"tests/data/experiments/weight_comparison_{timestamp}.json"
```

#### `tests/evaluate_sentry_defense.py`
**修改内容**: `save_evaluation_results()` 方法
```python
# 修改前
output_dir = Path(__file__).parent.parent / "backend" / "data" / "experiments"

# 修改后
output_dir = Path(__file__).parent / "data" / "experiments"
```

### 3. 数据可视化脚本

#### `tests/visualize_experiment.py`
**修改内容**:
1. `generate_all_plots()` 方法 - 图表保存路径
2. `main()` 函数 - 数据文件读取路径

```python
# 修改前
output_dir = str(Path(__file__).parent.parent / "backend" / "data" / "experiments" / "plots")
data_dir = Path(__file__).parent.parent / "backend" / "data" / "experiments"

# 修改后
output_dir = str(Path(__file__).parent / "data" / "experiments" / "plots")
data_dir = Path(__file__).parent / "data" / "experiments"
```

#### `tests/visualize_weight_comparison.py`
**修改内容**:
1. `generate_all_plots()` 方法 - 图表保存路径
2. `main()` 函数 - 数据文件读取路径（保留兼容性）

```python
# 修改前
output_dir = str(Path(__file__).parent.parent / "backend" / "data" / "experiments" / "plots")
possible_paths = [
    Path(__file__).parent.parent / "backend" / "data" / "experiments",
    ...
]

# 修改后
output_dir = str(Path(__file__).parent / "data" / "experiments" / "plots")
possible_paths = [
    Path(__file__).parent / "data" / "experiments",  # 新路径
    Path(__file__).parent.parent / "backend" / "data" / "experiments",  # 旧路径（兼容）
    ...
]
```

#### `tests/visualize_sentry_defense.py`
**修改内容**:
1. `generate_all_plots()` 方法 - 图表保存路径
2. `main()` 函数 - 数据文件读取路径

```python
# 修改前
output_dir = str(Path(__file__).parent.parent / "backend" / "data" / "experiments" / "plots")
data_dir = Path(__file__).parent.parent / "backend" / "data" / "experiments"

# 修改后
output_dir = str(Path(__file__).parent / "data" / "experiments" / "plots")
data_dir = Path(__file__).parent / "data" / "experiments"
```

## 新的目录结构

```
Agent_Misevolution_Safety/
├── backend/
│   ├── storage/
│   │   └── experiment_data.py    # 修改：默认路径指向 tests/data/experiments
│   └── ...
├── tests/
│   ├── data/
│   │   └── experiments/          # 所有实验数据统一保存到这里
│   │       ├── batch_experiment_*.json
│   │       ├── weight_comparison_*.json
│   │       ├── sentry_defense_evaluation_*.json
│   │       └── plots/            # 图表保存目录
│   ├── run_batch_experiment.py   # 修改：保存路径
│   ├── compare_weights_experiment.py  # 修改：保存路径
│   ├── evaluate_sentry_defense.py     # 修改：保存路径
│   ├── visualize_experiment.py        # 修改：读取/保存路径
│   ├── visualize_weight_comparison.py # 修改：读取/保存路径（保留兼容）
│   └── visualize_sentry_defense.py    # 修改：读取/保存路径
└── ...
```

## 优势

1. **更清晰的组织结构**
   - 实验数据专门放在 `tests/data` 目录
   - 与 `backend` 目录分离，职责更明确

2. **简化路径管理**
   - 使用 `Path(__file__).parent` 相对路径，不依赖工作目录
   - 自动创建目录，无需手动操作

3. **向后兼容**
   - `visualize_weight_comparison.py` 保留了对旧路径的搜索
   - 如果 `tests/data` 中找不到，会尝试 `backend/data`

4. **便于维护**
   - 所有数据文件统一位置
   - 清理和备份更方便

## 使用说明

### 运行实验
```bash
cd backend
python ../tests/run_batch_experiment.py  # 数据保存到 tests/data/experiments
```

### 生成可视化
```bash
cd tests
python visualize_experiment.py  # 从 tests/data/experiments 读取数据
```

### 查看数据
```bash
ls tests/data/experiments/
# batch_experiment_20240113_123456.json
# weight_comparison_20240113_123456.json
# sentry_defense_evaluation_20240113_123456.json

ls tests/data/experiments/plots/
# violation_rate_evolution_20240113_123456.png
# ...
```

## 注意事项

1. **旧数据迁移**
   - 如果 `backend/data/experiments` 中有旧数据，建议迁移到 `tests/data/experiments`
   - 可视化脚本会自动搜索新旧两个位置

2. **路径兼容性**
   - `visualize_weight_comparison.py` 保留了对旧路径的支持
   - 其他可视化脚本只搜索新路径

3. **工作目录**
   - 测试脚本需要从 `backend` 目录运行（因为设置了 `os.chdir(backend_path)`）
   - 但数据保存位置不再依赖工作目录，使用绝对路径
